<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Faculty Selection</title>
    <link rel="stylesheet" href="/styles/allotment.css">
</head>

<body>
    <form id="faculty-allocation-form">
        <!-- Program Dropdown -->
        <label for="program">Select Program:</label>
        <select id="program" name="program">
            <% if (departmentData && departmentData.programs) { %>
                <% departmentData.programs.forEach(function(program) { %>
                    <option value="<%= program.programme_id %>"><%= program.programme_name %></option>
                <% }) %>
            <% } else { %>
                <option value="">No Programs Available</option>
            <% } %>
        </select>

        <!-- Core Courses Table Grouped by Semester (Excluding Electives) -->
        <% if (departmentData && departmentData.courses) { %>
            <% 
                const groupedCoreCourses = {};
                departmentData.courses.forEach(function(course) {
                    if (course.course_type !== 'Elective') {
                        if (!groupedCoreCourses[course.semester_number]) {
                            groupedCoreCourses[course.semester_number] = [];
                        }
                        groupedCoreCourses[course.semester_number].push(course);
                    }
                });
            %>

            <% Object.keys(groupedCoreCourses).forEach(function(semester) { %>
                <h2>Semester: <%= semester %></h2>
                <table>
                    <thead>
                        <tr>
                            <th>Course Name</th>
                            <th>Faculty</th>
                            <th>Hours Per Week</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% groupedCoreCourses[semester].forEach(function(course) { %>
                            <tr>
                                <td><%= course.course_id %> - <%= course.course_name %></td>
                                <td>
                                    <div class="dropdown">
                                        <button type="button">Select Faculties</button>
                                        <div class="dropdown-content">
                                            <% if (departmentData.faculties) { %>
                                                <% departmentData.faculties.forEach(function(faculty) { %>
                                                    <label>
                                                        <input type="checkbox" 
                                                               class="faculty-checkbox" 
                                                               data-course-id="<%= course.course_id %>" 
                                                               value="<%= faculty.faculty_id %>" 
                                                               data-name="<%= faculty.name %>"> 
                                                        <%= faculty.name %>
                                                    </label>
                                                <% }) %>
                                            <% } else { %>
                                                <p>No Faculties Available</p>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div id="selected-faculty-<%= course.course_id %>" class="selected-faculty"></div>
                                </td>
                                <td><%= course.hours_per_week %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            <% }) %>
        <% } else { %>
            <p>No Courses Available</p>
        <% } %>

        <!-- Elective Courses Section -->
        <% if (departmentData && departmentData.electives) { %>
            <h2>Electives</h2>
            <% departmentData.electives.forEach(function(elective) { %>
                <div class="elective-group">
                    <h3>Program: <%= elective.programme_id %> - Semester: <%= elective.semester_number %></h3>
                    <% for (let i = 1; i <= elective.number_of_electives; i++) { %>
                        <div class="elective-course" id="elective-course-group-<%= elective.semester_number %>-<%= i %>">
                            <label>Elective <%= i %>:</label>
                            <div class="elective-courses">
                                <div class="elective-course-entry">
                                </div>
                            </div>
                            <button type="button" class="add-course-btn" 
                                data-semester="<%= elective.semester_number %>" 
                                data-elective="<%= i %>" 
                                data-program="<%= elective.programme_id %>">Add Another Course</button>
                        </div>
                    <% } %>
                </div>
            <% }) %>
        <% } %>
        
        <!-- Submit button -->
        <button type="button" id="submit-button">Submit Allocation</button>
    </form>

    <script>
        // Object to track how many courses each faculty is assigned and their max workload.
    const facultyWorkload = {};

    // Load max workload for each faculty from programData
    const programData = JSON.parse(`<%- JSON.stringify(departmentData).replace(/\\/g, '\\\\').replace(/"/g, '\\"') %>`);

    // Populate the initial workload object
    programData.faculties.forEach(faculty => {
        facultyWorkload[faculty.faculty_id] = {
            assigned: 0, // Initially, no courses assigned
            max_workload: faculty.max_workload
        };
    });

    // Function to handle workload tracking and warning popup
    function handleFacultySelection(checkbox, facultyClass) {
        const facultyId = checkbox.value;
        const isChecked = checkbox.checked;
        const facultyName = checkbox.dataset.name;
        const currentWorkload = facultyWorkload[facultyId];

        if (isChecked) {
            // Check if the faculty has already reached their max workload
            if (currentWorkload.assigned >= currentWorkload.max_workload) {
                alert(`Warning: ${facultyName} is already assigned to ${currentWorkload.max_workload} courses. Cannot assign to more.`);
                checkbox.checked = false; // Uncheck the checkbox
            } else {
                // Increase the count for this faculty member
                currentWorkload.assigned += 1;
            }
        } else {
            // Decrease the count when a faculty is deselected
            currentWorkload.assigned = Math.max(0, currentWorkload.assigned - 1);
        }

        const courseId = checkbox.dataset.courseId;
        updateSelectedFaculty(courseId, facultyClass, 'selected-faculty-' + courseId);
    }

    // Function to handle faculty selection updates (common for both static and dynamic elements)
    function updateSelectedFaculty(courseId, facultyClass, facultyDivId) {
        const selectedFacultyDiv = document.getElementById(facultyDivId);

        // Get all selected checkboxes for this course
        const selectedCheckboxes = document.querySelectorAll(`.${facultyClass}[data-course-id="${courseId}"]:checked`);

        // Get selected faculty names
        const selectedFacultyNames = Array.from(selectedCheckboxes).map(function (checkbox) {
            return checkbox.dataset.name;
        });

        // Update the displayed selected faculty names
        selectedFacultyDiv.textContent = selectedFacultyNames.join(', ');
    }

    // Event listener for static faculty selection (for already existing static courses)
    document.querySelectorAll('.faculty-checkbox').forEach(function (checkbox) {
        checkbox.addEventListener('change', function (event) {
            handleFacultySelection(event.target, 'faculty-checkbox');
        });
    });

    // Event listener for static elective faculty selection
    document.querySelectorAll('.faculty-checkbox-elective').forEach(function (checkbox) {
        checkbox.addEventListener('change', function (event) {
            handleFacultySelection(event.target, 'faculty-checkbox-elective');
        });
    });

    // JavaScript to handle dynamic addition of courses for electives
    document.querySelectorAll('.add-course-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const semester = button.dataset.semester;
            const elective = button.dataset.elective;
            const groupContainer = document.getElementById(`elective-course-group-${semester}-${elective}`);

            // Create a new unique course entry with a temporary ID
            const courseEntry = document.createElement('div');
            const courseId = `${semester}-${elective}-${Date.now()}`; // Temporary unique ID

            courseEntry.className = 'elective-course-entry';
            courseEntry.innerHTML = `
                <select name="electives[${semester}][${elective}][]" class="elective-course-select" data-course-id="${courseId}">
                    <option value="">Select a course</option>
                    <% departmentData.courses.forEach(function (course) { %>
                        <% if (course.course_type === 'Elective') { %>
                            <option value="<%= course.course_id %>"><%= course.course_id %> <%= course.course_name %></option>
                        <% } %>
                    <% }) %>
                </select>
                <br/>
                <label>Assign Faculty:</label>
                <div class="dropdown">
                    <button type="button">Select Faculties</button>
                    <div class="dropdown-content">
                        <% allFaculties.forEach(function (faculty) { %>
                            <label>
                                <input type="checkbox"
                                    class="faculty-checkbox-elective"
                                    data-course-id="${courseId}"
                                    value="<%= faculty.faculty_id %>"
                                    data-name="<%= faculty.name %>">
                                <%= faculty.name %>
                            </label>
                        <% }) %>
                    </div>
                </div>
                <label for="student-strength">Student Strength:</label>
                <input type="number" name="electives[${semester}][${elective}][student_strength]" min="1" required placeholder="Enter student strength" data-course-id="${courseId}">
                <br/>
                <div id="selected-faculty-${courseId}" class="selected-faculty"></div>
                <button type="button" class="remove-course-btn">Remove Course</button>
            `;

            // Append the course entry to the elective group
            groupContainer.querySelector('.elective-courses').appendChild(courseEntry);

            // Add event listener for removing the course
            courseEntry.querySelector('.remove-course-btn').addEventListener('click', function () {
                courseEntry.remove();
            });

            // Add event listener for dynamically selected courses to update checkboxes
            const courseSelect = courseEntry.querySelector('.elective-course-select');
            courseSelect.addEventListener('change', function () {
                const selectedCourseId = courseSelect.value;

                // Update the actual course ID on faculty checkboxes when a course is selected
                courseEntry.querySelectorAll('.faculty-checkbox-elective').forEach(function (checkbox) {
                    checkbox.setAttribute('data-course-id-actual', selectedCourseId);
                });
            });

            // Add event listener for faculty selection checkboxes
            courseEntry.querySelectorAll('.faculty-checkbox-elective').forEach(function (checkbox) {
                checkbox.addEventListener('change', function (event) {
                    handleFacultySelection(event.target, 'faculty-checkbox-elective');
                });
            });
        });
    });
    
    // Event listener to remove course options for static elective courses
    document.querySelectorAll('.remove-course-btn').forEach(function (button) {
            button.addEventListener('click', function () {
                button.parentElement.remove();
            });
        });


    // Gather selected faculties for electives
    document.getElementById('submit-button').addEventListener('click', function () {
        const selectedData = {
            program: document.getElementById('program').value,
            coreCourses: {},
            electives: {}
        };

    // Gather selected faculties for core courses
    document.querySelectorAll('.faculty-checkbox:checked').forEach(function (checkbox) {
        const courseId = checkbox.dataset.courseId;
        if (!selectedData.coreCourses[courseId]) {
            selectedData.coreCourses[courseId] = [];
        }
        selectedData.coreCourses[courseId].push(checkbox.value);
    });

    // Gather selected faculties and student strength for electives
    document.querySelectorAll('.faculty-checkbox-elective:checked').forEach(function (checkbox) {
        const courseId = checkbox.dataset.courseIdActual; // Now this will have the actual selected course ID
        const [semesterNo, electiveNo] = checkbox.dataset.courseId.split('-'); // Extract semester and elective numbers

        if (!selectedData.electives[semesterNo]) {
            selectedData.electives[semesterNo] = {}; // Initialize semester
        }
        if (!selectedData.electives[semesterNo][`Elective ${electiveNo}`]) {
            selectedData.electives[semesterNo][`Elective ${electiveNo}`] = {}; // Initialize elective group
        }

        if (!selectedData.electives[semesterNo][`Elective ${electiveNo}`][courseId]) {
            selectedData.electives[semesterNo][`Elective ${electiveNo}`][courseId] = {
                faculty: [],
                strength: 0
            };
        }

        selectedData.electives[semesterNo][`Elective ${electiveNo}`][courseId].faculty.push(checkbox.value);
    });

    // Gather student strength inputs
    document.querySelectorAll('input[name^="electives"][type="number"]').forEach(function (input) {
        const nameParts = input.name.match(/electives\[(\d+)\]\[(\d+)\]\[student_strength\]/);
        if (nameParts) {
            const semesterNo = nameParts[1];
            const electiveNo = nameParts[2];
            const courseSelect = input.closest('.elective-course-entry').querySelector('.elective-course-select');
            const courseId = courseSelect ? courseSelect.value : null;

            if (courseId) {
                // Ensure the structure exists in selectedData
                if (!selectedData.electives[semesterNo]) {
                    selectedData.electives[semesterNo] = {};
                }
                if (!selectedData.electives[semesterNo][`Elective ${electiveNo}`]) {
                    selectedData.electives[semesterNo][`Elective ${electiveNo}`] = {};
                }
                if (!selectedData.electives[semesterNo][`Elective ${electiveNo}`][courseId]) {
                    selectedData.electives[semesterNo][`Elective ${electiveNo}`][courseId] = { faculty: [] };
                }

                // Assign the strength
                const strengthValue = input.value;
                
                if (!isNaN(strengthValue)) {
                    selectedData.electives[semesterNo][`Elective ${electiveNo}`][courseId].strength = strengthValue;
                }
            } else {
                console.warn("Course ID not found for an elective entry. Ensure a course is selected.");
            }
        }
    });

    alert("hieeee");

    // Submit the data to the backend
    fetch('/addAllotments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(selectedData)
    })
    .then(response => response.json())
    .then(data => {
        alert('Submission successful: ' + JSON.stringify(data));
    })
    .catch(error => {
        console.error('Error submitting data:', error);
        alert('Error submitting data. Please try again.');
    });
});

    
    </script>  
    
</body>

</html>